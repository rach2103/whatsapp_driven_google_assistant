# WhatsApp Drive Assistant API Documentation

## Overview

The WhatsApp Drive Assistant provides a conversational interface to Google Drive through WhatsApp messages. This document describes the command syntax, webhook endpoints, and integration details.

## Command Reference

### LIST Command

Lists files and folders in a specified Google Drive directory.

**Syntax:**
```
LIST /path/to/folder
```

**Examples:**
```
LIST /ProjectX
LIST /Documents/Reports
LIST /
```

**Response Format:**
```
üìÅ Files in /ProjectX:

üìÑ report.pdf
   Size: 1.2 MB | Modified: 12/15/2024

üìù notes.docx
   Size: 456 KB | Modified: 12/14/2024

üìä data.xlsx
   Size: 2.1 MB | Modified: 12/13/2024

üìä Total: 3 items
```

**Error Responses:**
- `LIST command requires a path. Example: LIST /ProjectX`
- `üìÅ No files found in /path`

### DELETE Command

Deletes a specific file from Google Drive. Requires CONFIRM keyword for safety.

**Syntax:**
```
DELETE /path/to/file.ext CONFIRM
```

**Examples:**
```
DELETE /ProjectX/old-report.pdf CONFIRM
DELETE /Archive/temp.docx CONFIRM
```

**Response Format:**
```
üóëÔ∏è File Deleted Successfully

üìÑ File: old-report.pdf
‚è∞ Time: 12/15/2024, 2:30:45 PM

‚úÖ Operation completed and logged.
```

**Error Responses:**
- `DELETE command requires CONFIRM keyword for safety. Example: DELETE /path/file.pdf CONFIRM`
- `DELETE command requires a path. Example: DELETE /ProjectX`
- `‚ùå Delete Failed - File not found or access denied.`

### MOVE Command

Moves a file from one location to another in Google Drive.

**Syntax:**
```
MOVE /source/path/file.ext /destination/path
```

**Examples:**
```
MOVE /ProjectX/report.pdf /Archive
MOVE /Drafts/document.docx /Published
```

**Response Format:**
```
üìÇ File Moved Successfully

üìÑ File: report.pdf
üìÅ From: /ProjectX
üìÅ To: /Archive
‚è∞ Time: 12/15/2024, 2:30:45 PM

‚úÖ Operation completed and logged.
```

**Error Responses:**
- `MOVE command requires source and destination paths. Example: MOVE /source/file.pdf /destination`
- `‚ùå Move Failed - Source file not found or destination invalid.`

### SUMMARY Command

Generates AI-powered summaries of all documents in a specified folder.

**Syntax:**
```
SUMMARY /path/to/folder
```

**Examples:**
```
SUMMARY /ProjectX
SUMMARY /Reports/2024
```

**Response Format:**
```
üìÑ Document Summaries for /ProjectX:

üìù project-plan.pdf
‚Ä¢ Project timeline spans 6 months
‚Ä¢ Budget allocated: $50,000
‚Ä¢ Key milestones include design, development, testing
‚Ä¢ Team size: 8 members

---

üìù meeting-notes.docx
‚Ä¢ Weekly team meeting recap
‚Ä¢ Action items assigned to team leads
‚Ä¢ Next meeting scheduled for Friday
‚Ä¢ Budget review pending

---

ü§ñ Summaries generated by AI | 2 documents processed
```

**Error Responses:**
- `SUMMARY command requires a path. Example: SUMMARY /ProjectX`
- `üìÑ No documents found in /path for summarization.`

### HELP Command

Displays available commands and usage instructions.

**Syntax:**
```
HELP
```

**Response Format:**
```
üì± WhatsApp Drive Assistant Commands:

üìÅ LIST /folder - List files in folder
   Example: LIST /ProjectX

üóëÔ∏è DELETE /path/file.pdf CONFIRM - Delete file (requires CONFIRM)
   Example: DELETE /ProjectX/report.pdf CONFIRM

üìÇ MOVE /source/file.pdf /destination - Move file
   Example: MOVE /ProjectX/report.pdf /Archive

üìÑ SUMMARY /folder - AI summaries of documents
   Example: SUMMARY /ProjectX

‚ùì HELP - Show this message

‚ö†Ô∏è Safety Notes:
‚Ä¢ DELETE requires CONFIRM keyword
‚Ä¢ All operations are logged
‚Ä¢ Only your authenticated Drive is accessed
```

## Webhook API

### Endpoint

```
POST /webhook/whatsapp-webhook
```

### Headers

```
Content-Type: application/x-www-form-urlencoded
X-Twilio-Signature: <signature>
```

### Request Body

Twilio sends webhook data in URL-encoded format:

```
From=whatsapp:+1234567890
&Body=LIST /ProjectX
&MessageSid=SM1234567890abcdef
&AccountSid=AC1234567890abcdef
&To=whatsapp:+14155238886
```

### Parameters

| Parameter | Description | Required |
|-----------|-------------|----------|
| From | WhatsApp number that sent the message | Yes |
| Body | Message content/command | Yes |
| MessageSid | Unique message identifier | Yes |
| AccountSid | Twilio account identifier | Yes |
| To | Twilio WhatsApp number | Yes |

### Response

The webhook returns HTTP 200 with "OK" body for all requests. Actual responses are sent back to WhatsApp via Twilio API.

### Security

- **Signature Verification**: All webhooks are verified using Twilio signature
- **Authentication**: Google Drive access uses OAuth2
- **Rate Limiting**: Configurable limits prevent abuse
- **Audit Logging**: All operations are logged to Google Sheets

## Error Handling

### Command Validation Errors

```json
{
  "error": true,
  "message": "Invalid command: INVALID. Use HELP for available commands.",
  "from": "whatsapp:+1234567890",
  "timestamp": "2024-12-15T14:30:45.123Z",
  "originalMessage": "INVALID"
}
```

### Google Drive API Errors

- **File Not Found**: When specified file doesn't exist
- **Permission Denied**: When user lacks access rights
- **Quota Exceeded**: When API limits are reached
- **Network Errors**: When Google services are unavailable

### OpenAI API Errors

- **Invalid API Key**: When OpenAI credentials are incorrect
- **Rate Limit**: When OpenAI usage limits are exceeded
- **Content Policy**: When document content violates policies

## Integration Details

### Google Drive Integration

**OAuth2 Scopes Required:**
- `https://www.googleapis.com/auth/drive`
- `https://www.googleapis.com/auth/drive.file`

**Supported File Types:**
- PDF documents
- Microsoft Word (.docx, .doc)
- Google Docs
- Text files (.txt)
- Microsoft Excel (.xlsx, .xls)
- Google Sheets
- Microsoft PowerPoint (.pptx, .ppt)
- Google Slides

### Twilio Integration

**Required Twilio Products:**
- WhatsApp Business API (Sandbox for development)
- Programmable Messaging

**Webhook Configuration:**
- Method: POST
- Content Type: application/x-www-form-urlencoded
- Signature verification: Enabled

### OpenAI Integration

**Model Used:** GPT-4o
**Max Tokens:** 500 per summary
**Temperature:** 0.3 (focused, consistent responses)

## Rate Limits

| Operation | Limit | Window |
|-----------|-------|--------|
| All Commands | 10 requests | 1 minute |
| All Commands | 100 requests | 1 hour |
| Summary Generation | 5 requests | 5 minutes |
| File Operations | 20 requests | 10 minutes |

## Audit Logging

All operations are logged to a Google Sheets document with the following structure:

| Column | Description |
|--------|-------------|
| Timestamp | ISO 8601 timestamp |
| From | WhatsApp number |
| Operation | Command type |
| Message | Original command or response |
| Status | SUCCESS or FAILED |
| Target | File/folder affected |
| Count | Number of items processed |

## Development and Testing

### Local Testing

Use the provided test script to simulate webhook calls:

```bash
# Test all commands
./scripts/test-webhook.sh all

# Test specific command
./scripts/test-webhook.sh list
```

### ngrok Setup

For local development with external webhook access:

```bash
# Install ngrok
npm install -g ngrok

# Expose n8n
ngrok http 5678

# Update Twilio webhook URL with ngrok URL
```

### Environment Variables

Key environment variables for integration:

```env
# Google Drive
GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_SECRET=your_client_secret

# Twilio
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# OpenAI
OPENAI_API_KEY=your_api_key

# Security
WEBHOOK_SECRET=your_webhook_secret
VERIFY_TWILIO_SIGNATURE=true
```

## Troubleshooting

### Common Issues

1. **Webhook not receiving messages**
   - Verify Twilio webhook URL
   - Check n8n accessibility
   - Confirm WhatsApp sandbox setup

2. **Google Drive authentication fails**
   - Verify OAuth2 credentials
   - Check redirect URI configuration
   - Ensure proper scopes

3. **AI summaries not working**
   - Validate OpenAI API key
   - Check usage quotas
   - Verify supported file types

4. **Commands not recognized**
   - Ensure proper command syntax
   - Check for typos in commands
   - Verify case sensitivity

### Debug Mode

Enable debug logging by setting:

```env
DEBUG_MODE=true
ENABLE_WEBHOOK_LOGS=true
LOG_LEVEL=debug
```

### Support

For additional support:
- Check execution logs in n8n interface
- Review audit logs in Google Sheets
- Use test scripts for validation
- Consult troubleshooting section in README